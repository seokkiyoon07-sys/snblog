name: Slack Blog Notification

on:
  push:
    branches: [ main ]
    paths:
      - 'src/data/posts.ts'
      - 'src/app/**/page.tsx'

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          # Check if posts.ts was modified
          if git diff --name-only HEAD~1 HEAD | grep -q "src/data/posts.ts"; then
            echo "posts_modified=true" >> $GITHUB_OUTPUT
          else
            echo "posts_modified=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if any blog pages were modified
          if git diff --name-only HEAD~1 HEAD | grep -qE "src/app/(originals|startup|columns|problems|reviews|admissions)/.*/page\.tsx$"; then
            echo "pages_modified=true" >> $GITHUB_OUTPUT
          else
            echo "pages_modified=false" >> $GITHUB_OUTPUT
          fi

      - name: Send to Slack
        if: steps.changes.outputs.posts_modified == 'true' || steps.changes.outputs.pages_modified == 'true'
        run: |
          # Get commit details
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          
          # Create message based on changes
          if [ "${{ steps.changes.outputs.posts_modified }}" == "true" ] && [ "${{ steps.changes.outputs.pages_modified }}" == "true" ]; then
            BODY="ğŸ”„ ë¸”ë¡œê·¸ ì½˜í…ì¸ ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
            DESCRIPTION="ìƒˆë¡œìš´ ê¸€ì´ ì¶”ê°€ë˜ê³  ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
            COLOR="warning"
          elif [ "${{ steps.changes.outputs.posts_modified }}" == "true" ]; then
            BODY="ğŸ“Š ë¸”ë¡œê·¸ ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
            DESCRIPTION="í¬ìŠ¤íŠ¸ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
            COLOR="good"
          else
            BODY="ğŸ“ ìƒˆë¡œìš´ ë¸”ë¡œê·¸ ê¸€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!"
            DESCRIPTION="ìƒˆë¡œìš´ í˜ì´ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
            COLOR="good"
          fi
          
          # Send to Slack
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"$BODY\",
              \"attachments\": [
                {
                  \"color\": \"$COLOR\",
                  \"title\": \"ğŸ“ SN Academy Blog\",
                  \"text\": \"$DESCRIPTION\",
                  \"thumb_url\": \"https://blog.snacademy.co.kr/logo.png\",
                  \"fields\": [
                    {
                      \"title\": \"ì‘ì„±ì\",
                      \"value\": \"$COMMIT_AUTHOR\",
                      \"short\": true
                    },
                    {
                      \"title\": \"ì»¤ë°‹ ë©”ì‹œì§€\",
                      \"value\": \"$COMMIT_MSG\",
                      \"short\": false
                    }
                  ],
                  \"actions\": [
                    {
                      \"type\": \"button\",
                      \"text\": \"ë¸”ë¡œê·¸ ë³´ê¸°\",
                      \"url\": \"https://blog.snacademy.co.kr\"
                    },
                    {
                      \"type\": \"button\",
                      \"text\": \"ì»¤ë°‹ ë³´ê¸°\",
                      \"url\": \"$COMMIT_URL\"
                    }
                  ]
                }
              ]
            }"
