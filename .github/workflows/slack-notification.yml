name: Slack Blog Notification

on:
  push:
    branches: [ main ]
    paths:
      - 'src/data/posts.ts'
      - 'src/app/**/page.tsx'

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          # Check if posts.ts was modified
          if git diff --name-only HEAD~1 HEAD | grep -q "src/data/posts.ts"; then
            echo "posts_modified=true" >> $GITHUB_OUTPUT
          else
            echo "posts_modified=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if any blog pages were modified
          if git diff --name-only HEAD~1 HEAD | grep -qE "src/app/(originals|startup|columns|problems|reviews|admissions)/.*/page\.tsx$"; then
            echo "pages_modified=true" >> $GITHUB_OUTPUT
          else
            echo "pages_modified=false" >> $GITHUB_OUTPUT
          fi

      - name: Send to Slack
        if: steps.changes.outputs.posts_modified == 'true' || steps.changes.outputs.pages_modified == 'true'
        run: |
          # Get commit details
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          
          # Create message based on changes
          if [ "${{ steps.changes.outputs.posts_modified }}" == "true" ] && [ "${{ steps.changes.outputs.pages_modified }}" == "true" ]; then
            BODY="🔄 블로그 콘텐츠가 업데이트되었습니다!"
            DESCRIPTION="새로운 글이 추가되고 데이터가 업데이트되었습니다."
            COLOR="warning"
          elif [ "${{ steps.changes.outputs.posts_modified }}" == "true" ]; then
            BODY="📊 블로그 데이터가 업데이트되었습니다!"
            DESCRIPTION="포스트 정보가 수정되었습니다."
            COLOR="good"
          else
            BODY="📝 새로운 블로그 글이 추가되었습니다!"
            DESCRIPTION="새로운 페이지가 생성되었습니다."
            COLOR="good"
          fi
          
          # Send to Slack
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"$BODY\",
              \"attachments\": [
                {
                  \"color\": \"$COLOR\",
                  \"title\": \"📝 SN Academy Blog\",
                  \"text\": \"$DESCRIPTION\",
                  \"thumb_url\": \"https://blog.snacademy.co.kr/logo.png\",
                  \"fields\": [
                    {
                      \"title\": \"작성자\",
                      \"value\": \"$COMMIT_AUTHOR\",
                      \"short\": true
                    },
                    {
                      \"title\": \"커밋 메시지\",
                      \"value\": \"$COMMIT_MSG\",
                      \"short\": false
                    }
                  ],
                  \"actions\": [
                    {
                      \"type\": \"button\",
                      \"text\": \"블로그 보기\",
                      \"url\": \"https://blog.snacademy.co.kr\"
                    },
                    {
                      \"type\": \"button\",
                      \"text\": \"커밋 보기\",
                      \"url\": \"$COMMIT_URL\"
                    }
                  ]
                }
              ]
            }"
