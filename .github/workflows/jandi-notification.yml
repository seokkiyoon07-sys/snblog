name: Blog Notification (Jandi + Slack)

on:
  push:
    branches: [main]
    paths:
      - 'src/data/posts.ts'
      - 'src/app/**/page.tsx'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: changes
        run: |
          # Check if posts.ts was modified
          if echo "${{ github.event.head_commit.modified }}" | grep -q "src/data/posts.ts"; then
            echo "posts_modified=true" >> $GITHUB_OUTPUT
          else
            echo "posts_modified=false" >> $GITHUB_OUTPUT
          fi

          # Check if any blog pages were modified
          if echo "${{ github.event.head_commit.modified }}" | grep -qE "src/app/(originals|startup|columns|problems|reviews|admissions)/.*/page\.tsx$"; then
            echo "pages_modified=true" >> $GITHUB_OUTPUT
          else
            echo "pages_modified=false" >> $GITHUB_OUTPUT
          fi

      - name: Send to Jandi and Slack
        if: steps.changes.outputs.posts_modified == 'true' || steps.changes.outputs.pages_modified == 'true'
        run: |
          # Get commit details
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          # Simple notification message
          MESSAGE="ğŸš€ ìƒˆë¡œìš´ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!

          ğŸ“ ì»¤ë°‹: $COMMIT_MSG
          ğŸ‘¤ ì‘ì„±ì: $COMMIT_AUTHOR
          ğŸ”— ë§í¬: $COMMIT_URL
          ğŸŒ ë¸”ë¡œê·¸: https://blog.snacademy.co.kr"

          # Send to Jandi
          if [ -n "${{ secrets.JANDI_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.JANDI_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"body\": \"$MESSAGE\",
                \"connectColor\": \"#FF6B6B\"
              }"
          fi

          # Send to Slack
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"text\": \"$MESSAGE\"
              }"
          fi
